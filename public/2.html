<!doctype html>
<html lang="es">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="css/style1.css"/>
    <title>Versión 2 - Ricardo Rendich</title>

  </head>
  <body>

    <div class="container-fluid">
        <h2>Plan Nacional de Desarrollo de Paraguay (PND)</h2>
        <p>Haz click en las secciones de colores del gráfico de la izquierda para conocer cómo se compone el Plan Nacional de Desarrollo de Paraguay (PND).
        </p>
        <p>Para volver al nivel anterior, haz click en el centro del mismo gráfico.
        </p>
        <p>También puedes navegar utilizando la lista de la derecha.
        </p>

        <div class="row">
          <div class="col-md-6">
            <div class="">
              <!--svg id="partitionSVG" width="100%" height="100%" viewBox="0 0 100 100"></svg-->
                <svg id="partitionSVG" viewBox="0 0 100 100"></svg>
            </div>
          </div>
          <div class="col-md-6">
            <br>
            <div id="id_select2"  class="btn btn-danger "></div>
            <br>
            <br>
            <div id="myTable2"></div>
          </div>
        </div>
    </div>
        <footer class="text-center">
          <p>Sitio desarrollado por Ricardo Rendich</p>
        </footer>

    <script src='https://d3js.org/d3.v4.min.js'></script>
    <script type="text/javascript">

    //d3.csv("data/data2.csv", function(error, data) {
    d3.csv("data/my_input2.csv", function(error, data) {

        var select = d3.select("#id_select2")
          .append("div")
          .append("select").
          attr("class", "btn btn-danger").
          attr("id", "queryDays")

        select
          .on("change", function(d) {
            var v = d3.select(this).property("value");
            console.log(v)
            moveStackToFront(v);
            function moveStackToFront(elD) {
                console.log("SI2: " + elD);
                svg.selectAll('.slice').filter(d => d.data.id == elD)
                //svg.selectAll('.slice').filter(d => d.value == elD)
                    .each(function(d) {
                        console.log("SI")
                        focusOn(d)
                        paint(d)
                    })}
          });
          var expensesByName = d3.nest()
            //.key(function(d) { return d.ODS_grupo; })
            .key(function(d) { return d.PND_grupo; })
            .key(function(d) { return d.PND_subgrupo; })
            .entries(data);
            console.log(expensesByName)

/*
            select
  .selectAll('optgroup')
    .data(expensesByName)
    .enter()
  .append('optgroup')
    .attr('value',function (d) { return d.key })
    .attr('label',function (d) { return d.key})
  .selectAll('option')
    .data(function (d) { return d.values })
    .enter()
  .append('option')
    //.attr('value',function (d) { return d.ODS_subgrupo })
    .attr('value',function (d) { return d.PND_subgrupo })
    //.text(function (d) { return d })
  .text(function (d) {
    max_string = 80 //18 // CARACTERES DE CADA OPTION DEL SELECT (LARGO)
       if(d['Objetivo PND'].length > max_string)
           return d['Objetivo PND'].substring(0,max_string)+'...';
       else
           return d['Objetivo PND'];
   });*/

   select
     .selectAll('optgroup')
       .data(expensesByName)
       .enter()
     .append('optgroup')
       .attr('value',function (d) { return d.key })
       .attr('label',function (d) { return d.key})
     .selectAll('option')
       .data(function (d) { return d.values })
       //.data(d3.map(expensesByName, function(d){return d.values;}).keys())

       .enter()
     .append('option')
       .attr('value',function (d) { return d.key })
       //.text(function (d) { return d })
     .text(function (d) {
       max_string = 80 //18 // CARACTERES DE CADA OPTION DEL SELECT (LARGO)
       val = d.values[0]["Objetivo PND"]
          if(val.length > max_string)
              return val.substring(0,max_string)+'...';
          else
              return val;
      });


   select.insert("option",":first-child").
   attr('selected', 'selected').
   attr('value', 0). // REVISAR valor default
   text('Filtrar')

  }); // d3.csv("data.csv", function(error, data) {

  ///////////////////
  var tabulate = function (data,columns) {
      var table = d3.select('#myTable2')
      var thead = table.append('thead')
      var tbody = table.append('tbody')


        //data = data
        //.sort((a,b) => d3.ascending(a.PND_grupo, b.PND_grupo))

        thead.append('tr')
          .selectAll('th')
            .data(columns)
            .enter()
          .append('th')
            .text(function (d,i) {
              //console.log(["113"]+i)
              //if(i==3)
              if(i==0)
              {return "Objetivo Estratégico"}

              return d
            })

        var rows = tbody.selectAll('tr')
            .data(data)
            .enter()
          .append('tr').attr('class', function (d) {
            //return d.ODS_grupo +" "+d.ODS_subgrupo
              return d.PND_grupo +" "+d.PND_subgrupo
           }) //AQUI
             .each(function (d) {
                d3.select(this).style("visibility", "collapse");
            });


        var cells = rows.selectAll('td')
            .data(function(row, row_index) {
                return columns.map(function (column, column_index) {
                  //console.log("row["+column+"("+row_index+"-"+column_index+")]: "+row[column])
                    return { column: column, value: row[column] }
              })
          })
          .enter()
        .append('td')/*
          .text(function (d) {
            //https://www.un.org/sustainabledevelopment/es/wp-content/uploads/sites/3/2016/01/S_SDG_Icons-01-12.jpg
            return d.value
          })*/
            //.text(function (d, i) {if (i != 1 && i != 2) return d.value })
            //.text(function (d, i) {if (i >0) return d.value })
            .text(function (d, i) {if (i != 0 && i != 3) return d.value })
  	.each(function(d, i) {
  		//if (i == 0) {
      if (i == 3) {
      	var imgData = [];
        //console.log(d.value)
        imgData.push(d.value);
        //the_image = "https://www.un.org/sustainabledevelopment/es/wp-content/uploads/sites/3/2016/01/S_SDG_Icons-01-"
        //if(d.value<10){the_image+="0"}
        the_image="img/ods"+d.value;

        d3.select(this).selectAll("img")
  				.data(imgData)
          .enter()
          .append("img") // doesn't append an <img> anywhere
          //.attr("src", d.value)
          .attr("src", the_image+".jpg")
          .attr("height", "110px")
          .attr("width", "110px");
      }
      else
      //if(i == 3){
      if(i == 0){

        // https://www.stp.gov.py/v1/pnd-en-construccion/
        	var imgData = [];
          //console.log(d)
          //console.log(d[i])
          //console.log(i)
//          console.log("---")
          imgData.push(d.value);
          //the_image = "https://www.un.org/sustainabledevelopment/es/wp-content/uploads/sites/3/2016/01/S_SDG_Icons-01-"
          //if(d.value<10){the_image+="0"}
          the_image="img/"+d.value;
          //the_image="img/pnd1.1";

          d3.select(this).selectAll("img")
    				.data(imgData)
            .enter()
            .append("img") // doesn't append an <img> anywhere
            //.attr("src", d.value)
            .attr("src", the_image+".png")
            .attr("height", "110px")
            .attr("width", "110px");

      }
  	})

        return table;

      return table;
    }
    d3.csv("data/my_input2.csv", function(error, data) {
      //const columns = ["ODS","Meta ODS","Objetivo PND", "PND_grupo"]
      const columns = ["PND_grupo","Objetivo PND","Meta ODS", "ODS"]
      tabulate(data,columns)
    });
////

	</script>
    <script>
        const width = window.innerWidth,
            height = window.innerHeight,
            maxRadius = (Math.min(width, height) / 2) - 5;

        const formatNumber = d3.format(',d');

        const x = d3.scaleLinear()
            .range([0, 2 * Math.PI])
            .clamp(true);

        const y = d3.scaleSqrt()
            .range([maxRadius*.1, maxRadius]);

        const color2 = d3.scaleOrdinal(d3.schemeCategory20);


        const partition = d3.partition();

        const arc = d3.arc()
            .startAngle(d => x(d.x0))
            .endAngle(d => x(d.x1))
            .innerRadius(d => Math.max(0, y(d.y0)))
            .outerRadius(d => Math.max(0, y(d.y1)));

        const middleArcLine = d => {
            const halfPi = Math.PI/2;
            const angles = [x(d.x0) - halfPi, x(d.x1) - halfPi];
            const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);

            const middleAngle = (angles[1] + angles[0]) / 2;
            const invertDirection = middleAngle > 0 && middleAngle < Math.PI; // On lower quadrants write text ccw
            if (invertDirection) { angles.reverse(); }

            const path = d3.path();
            path.arc(0, 0, r, angles[0], angles[1], invertDirection);
            return path.toString();
        };

        const textFits = d => {
            const CHAR_SPACE = 6;

            const deltaAngle = x(d.x1) - x(d.x0);
            const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);
            const perimeter = r * deltaAngle;

            return d.data.name.length * CHAR_SPACE < perimeter;
        };

        const svg = d3.select('#partitionSVG').append('svg')
                //.style('width', '100vw')
                //.style('height', '100vh')
                .style('width', '100%')
                .style('height', '100%')
            .attr('viewBox', `${-width / 3} ${-height / 3} ${2/3*width} ${2/3*height}`)
            .on('click', () => focusOn()); // Reset zoom on canvas click

        d3.json('data/my_input2.json', (error, root) => {
            if (error) throw error;

            root = d3.hierarchy(root);
          	console.log(root)
            //root.sum(d => d.value);
            root.sum(d => d.value);
            //root.sum(d => d.id);

            const slice = svg.selectAll('g.slice')
                .data(partition(root).descendants());

            slice.exit().remove();

            const newSlice = slice.enter()
                .append('g').attr('class', 'slice')
                .on('click', d => {
                    d3.event.stopPropagation();
                    //if(d.value != d3.select("#queryDays").value){
                    if(d.data.id != d3.select("#queryDays").value){
                      console.log(d)
                      console.log("[376] "+d.data.id +" - "+d.value +" - "+ d3.select("#queryDays").node().value)
                      d3.select("#queryDays").node().value = d.data.id
                      console.log(d3.select("#queryDays").node().value)
                      // PENDIENTE: AGREGAR GROUP
                      //if(!d3.select("#queryDays").node().value)
                      //{d3.select("#queryDays").node().value = d.data.id}

                      if(!d3.select("#queryDays").node().value)
                      {d3.select("#queryDays").node().value = 0}
                      paint(d)
                    }
                    focusOn(d);
                });

            //newSlice.append('title').text(d => d.data.name + '\n' + formatNumber(d.value));
            newSlice.append('title')
                .text(d => d.data.name );

                // Option 1: provide color names:
                var myColor = d3.scaleOrdinal().domain(d3.range(17))
                  .range(["FFFFFF",
                  "F2B729","F1B629", "F2B628", "F2B729",
                  "F1B728", "1A3F7A", "1A3F79", "50872F",
                  "F2B729", "1A3F79", "1A3F79", "508730",
                  "F1B628", "E65631", "E55530", "508730"

                ])

                //svg.selectAll(".firstrow").data(data).enter().append("circle").attr("cx", function(d,i){return 30 + i*60}).attr("cy", 50).attr("r", 19).attr("fill", function(d){return myColor(d) })

                newSlice.append('path')
                    .attr('class', 'main-arc')
                    .style('fill', function(d){
                      //console.log(d.data.name.indexOf("."))
                      //val = d.data.ods_class
                      val = d.data.pnd_class
                      //console.log(val)
                      return myColor(val) })
                    //color2((d.children ? d : d.parent).data.name))
                    .attr('d', arc);

/*
            newSlice.append('path')
                .attr('class', 'main-arc')
                .style('fill', d =>
                color2((d.children ? d : d.parent).data.name))
                .attr('d', arc);
                */

            newSlice.append('path')
                .attr('class', 'hidden-arc')
                .attr('id', (_, i) => `hiddenArc${i}`)
                .attr('d', middleArcLine);

            const text = newSlice.append('text')
                .attr('display', d => textFits(d) ? null : 'none');

            // Add white contour
            text.append('textPath')
                .attr('startOffset','50%')
                .attr('xlink:href', (_, i) => `#hiddenArc${i}` )
                .text(d => d.data.name)
                .style('fill', 'none')
                .style('stroke', '#fff')
                .style('stroke-width', 5)
                .style('stroke-linejoin', 'round');

            text.append('textPath')
                .attr('startOffset','50%')
                .attr('xlink:href', (_, i) => `#hiddenArc${i}` )
                .text(d => d.data.name);
        });

                function paint(d){
                  //console.log("421")
                    //console.log(d)

                  const tds = d3.selectAll("td")
                    .each(function(x, y) {
                      d3.select(this).style("background-color", this.innerHTML == d.data.id ? "yellow" : null)
                    })

                    var table = d3.select('#myTable2')
                    var tbody = table.select('tbody');
                      var rows = tbody.selectAll('tr')
                      .each(function (d) {
                         d3.select(this).style("visibility", function() {
                             return (true) ? "visible" : "hidden";
                         });
                     });
                     //tbody.selectAll('tr').selectAll(".FILA_1").style("visibility", function() {return true });
                       var rows = tbody.selectAll('tr')
                       .each(function (r) {
                          d3.select(this).style("visibility", function() {
                              //console.log(r) // AQUI AQUI
                              //return (r.ODS_subgrupo == d.data.id || r.ODS_grupo == d.data.id) ? "table-cell" : "collapse";
                              return (r.PND_subgrupo == d.data.id || r.PND_grupo == d.data.id) ? "table-cell" : "collapse";
                              //return (r.VALOR%2==0) ? "table-cell" : "collapse";
                          });
                      });

                }
        function focusOn(d = { x0: 0, x1: 1, y0: 0, y1: 1 }) {
            // Reset to top-level if no data point specified

            const transition = svg.transition()
                .duration(750)
                .tween('scale', () => {
                    const xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                        yd = d3.interpolate(y.domain(), [d.y0, 1]);
                    return t => { x.domain(xd(t)); y.domain(yd(t)); };
                });

            transition.selectAll('path.main-arc')
                .attrTween('d', d => () => arc(d));

            transition.selectAll('path.hidden-arc')
                .attrTween('d', d => () => middleArcLine(d));

            transition.selectAll('text')
                .attrTween('display', d => () => textFits(d) ? null : 'none');
        }

            d3.select("#queryDays").on("change", function() {
              var v = this.value;
              console.log(v)
              moveStackToFront(v);
                          function moveStackToFront(elD) {
                              console.log("SI2: " + elD)
                              //svg.selectAll('.slice').filter(d => d.value == elD)
                              svg.selectAll('.slice').filter(d => d.id == elD)
                                  .each(function(d) {
                                      console.log("SI")
                                      focusOn(d)
                                      paint(d)
                                  })
                          }
            })
    </script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </body>
</html>
