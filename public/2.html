<!doctype html>
<html lang="es">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

        <style>
        	<!--[if !IE]><!-->
        	<style>
        	* {
        	  margin: 0;
        	  padding: 0;
             }
             body {
        	   font: 14px/1.4 Georgia, Serif;
             }
            #page-wrap {
        	  /*margin: 50px;*/
        	  margin: 0px;
            }
            p {
        	 margin: 20px 0;
            }

        	/*
        	Generic Styling, for Desktops/Laptops
        	*/
        	table {
        		width: 100%;
        		border-collapse: collapse;
        	}
        	/* Zebra striping */
        	tr:nth-of-type(odd) {
        		background: #eee;
        	}
        	th {
        		background: #333;
        		color: white;
        		font-weight: bold;
        		/*cursor: s-resize;*/
        		background-repeat: no-repeat;
                background-position: 3% center;
        	}
        	td, th {
        		padding: 6px;
        		border: 1px solid #ccc;
        		text-align: left;
        	}

        	th.des:after {
              content: "\21E9";
            }

            th.aes:after {
              content: "\21E7";
            }

        	/*
        	Max width before this PARTICULAR table gets nasty
        	This query will take effect for any screen smaller than 760px
        	and also iPads specifically.
        	*/
        	@media
        	only screen and (max-width: 760px),
        	(min-device-width: 768px) and (max-device-width: 1024px)  {

        		/* Force table to not be like tables anymore */
        		table, thead, tbody, th, td, tr {
        			display: block;
        		}

        		/* Hide table headers (but not display: none;, for accessibility) */
        		thead tr {
        			position: absolute;
        			top: -9999px;
        			left: -9999px;
        		}

        		tr { border: 1px solid #ccc; }

        		td {
        			/* Behave  like a "row" */
        			border: none;
        			border-bottom: 1px solid #eee;
        			position: relative;
        			padding-left: 50%;
        		}

        		td:before {
        			/* Now like a table header */
        			position: absolute;
        			/* Top/left values mimic padding */
        			top: 6px;
        			left: 6px;
        			width: 45%;
        			padding-right: 10px;
        			white-space: nowrap;
        		}

        		/*
        		Label the data
        		*/
        		td:before {
        		  content: attr(data-th) ": ";
                  font-weight: bold;
                  width: 6.5em;
                  display: inline-block;
        		}
        	}

        	/* Smartphones (portrait and landscape) ----------- */
        	@media only screen
        	and (min-device-width : 320px)
        	and (max-device-width : 480px) {
        		body {
        			padding: 0;
        			margin: 0;
        			width: 320px; }
        		}

        	/* iPads (portrait and landscape) ----------- */
        	@media only screen and (min-device-width: 768px) and (max-device-width: 1024px) {
		body {
			width: 495px;
		}
	}
        </style>





            <style>

                .slice {
                    cursor: pointer;
                }

                .slice .main-arc {
                    stroke: #fff;
                    stroke-width: 1px;
                }

                .slice .hidden-arc {
                    fill: none;
                }

                .slice text {
                    pointer-events: none;
                    dominant-baseline: middle;
                    text-anchor: middle;
                }
                #partitionSVG{
                }
            </style>

    <title>Prototipo 1 - Ricardo Rendich</title>

  </head>
  <body>

    <div class="container-fluid">
        <h2>Entrada por PND</h2>

        <div class="row">
          <div class="col-md-6">
            <div class="">
              <svg id="partitionSVG" width="100%" height="100%" viewBox="0 0 100 100"></svg>
            </div>
          </div>
          <div class="col-md-6">
            <br>
            <div id="id_select"  class="btn btn-danger "></div>
            <br>
            <br>
            <div id="myTable"></div>
          </div>
        </div>
    </div>
        <footer class="text-center">
          <p>Sitio desarrollado por Ricardo Rendich</p>
        </footer>

            <script src='https://d3js.org/d3.v4.min.js'></script>
            <script type="text/javascript">
          /*
              ORIGINAL SOURCES:
              - http://bl.ocks.org/AMDS/4a61497182b8fcb05906
              - https://gist.github.com/sandeepkumarsingh01/0d112a3448ccafb219cc737493b31498
              */
            //d3.csv("data/data.csv", function(error, data) {
            //const whiteSpaceParser = d3.dsvFormat(";");
            //const data = whiteSpaceParser.parse(file, d3.autoType);
            //d3.dsv(";", "data2/data.csv").then((data) => {
            d3.csv("data/data2.csv", function(error, data) {
            var select = d3.select("#id_select")
              .append("div")
              .append("select").
              attr("class", "btn btn-danger").
              attr("id", "queryDays")

            select
              .on("change", function(d) {
                var v = d3.select(this).property("value");
                console.log(v)
                moveStackToFront(v);
                function moveStackToFront(elD) {
                    console.log("SI2: " + elD)
                    svg.selectAll('.slice').filter(d => d.value == elD)
                        .each(function(d) {
                            console.log("SI")
                            focusOn(d)
                            paint(d)
                        })}
              });

            select.selectAll("option")
              .data(data)
              .enter()
                .append("option")
                .attr("value", function (d) { return d.VALOR; })
                .text(function (d) {
                  max_string = 88
                     if(d.Indicadores.length > max_string)
                         return d.Indicadores.substring(0,max_string)+'...';
                     else
                         return d.Indicadores;
                 });
                 select.insert("option",":first-child").
                 attr('selected', 'selected').
                 attr('value', 956129). // REVISAR valor default
                 text('Filtrar')

          }); // d3.csv("data.csv", function(error, data) {

          ///////////////////
          var tabulate = function (data,columns) {
              var table = d3.select('#myTable')
              var thead = table.append('thead')
              var tbody = table.append('tbody')

                thead.append('tr')
                  .selectAll('th')
                    .data(columns)
                    .enter()
                  .append('th')
                    .text(function (d) { return d })

                var rows = tbody.selectAll('tr')
                    .data(data)
                    .enter()
                  .append('tr')

                var cells = rows.selectAll('td')
                    .data(function(row, row_index) {
                        return columns.map(function (column, column_index) {
                          //console.log("row["+column+"("+row_index+"-"+column_index+")]: "+row[column])
                            return { column: column, value: row[column] }
                      })
                  })
                  .enter()
                .append('td')
                  .text(function (d) { return d.value })

              return table;
            }
            //d3.csv("data/data.csv", function(error, data) {
            d3.csv("data/data2.csv", function(error, data) {
              const columns = ["VALOR",'Eje','Objetivo Estrat√©gico','Objetivo PND','Indicadores']
              tabulate(data,columns)
            });
        ////
            d3.csv("data/data.csv", function(error, data) {
        		  if (error) throw error;

        		  var sortAscending = true;
        		  var table = d3.select('#page-wrap').append('table');
        		  var titles = d3.keys(data[0]);
        		  var headers = table.append('thead').append('tr')
        		                   .selectAll('th')
        		                   .data(titles).enter()
        		                   .append('th')
        		                   .text(function (d) {
        			                    return d;
        		                    })
                                /*
        		                   .on('click', function (d) {
        		                	   headers.attr('class', 'header');
        		                	   if (sortAscending) {
        		                	     rows.sort(function(a, b) { return b[d] < a[d]; });
        		                	     sortAscending = false;
        		                	     this.className = 'aes';
        		                	   } else {
        		                		 rows.sort(function(a, b) { return b[d] > a[d]; });
        		                		 sortAscending = true;
        		                		 this.className = 'des';
        		                	   }
        		                   });*/

        		  var rows = table.append('tbody').selectAll('tr')
        		               .data(data).enter()
        		               .append('tr');

        		  rows.selectAll('td')
        		    .data(function (d) {
        		    	return titles.map(function (k) {
        		    		return { 'value': d[k], 'name': k};
        		    	});
        		    }).enter()
        		    .append('td')
        		    .attr('data-th', function (d) {
        		    	return d.name;
        		    })
        		    .text(function (d) {
        		    	return d.value;
        		    });
        	  });
        	</script>
            <script>
                const width = window.innerWidth,
                    height = window.innerHeight,
                    maxRadius = (Math.min(width, height) / 2) - 5;

                const formatNumber = d3.format(',d');

                const x = d3.scaleLinear()
                    .range([0, 2 * Math.PI])
                    .clamp(true);

                const y = d3.scaleSqrt()
                    .range([maxRadius*.1, maxRadius]);

                const color = d3.scaleOrdinal(d3.schemeCategory20);

                const partition = d3.partition();

                const arc = d3.arc()
                    .startAngle(d => x(d.x0))
                    .endAngle(d => x(d.x1))
                    .innerRadius(d => Math.max(0, y(d.y0)))
                    .outerRadius(d => Math.max(0, y(d.y1)));

                const middleArcLine = d => {
                    const halfPi = Math.PI/2;
                    const angles = [x(d.x0) - halfPi, x(d.x1) - halfPi];
                    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);

                    const middleAngle = (angles[1] + angles[0]) / 2;
                    const invertDirection = middleAngle > 0 && middleAngle < Math.PI; // On lower quadrants write text ccw
                    if (invertDirection) { angles.reverse(); }

                    const path = d3.path();
                    path.arc(0, 0, r, angles[0], angles[1], invertDirection);
                    return path.toString();
                };

                const textFits = d => {
                    const CHAR_SPACE = 6;

                    const deltaAngle = x(d.x1) - x(d.x0);
                    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);
                    const perimeter = r * deltaAngle;

                    return d.data.name.length * CHAR_SPACE < perimeter;
                };

                const svg = d3.select('#partitionSVG').append('svg')
                        .style('width', '100vw')
                        .style('height', '100vh')
                    .attr('viewBox', `${-width / 3} ${-height / 3} ${2/3*width} ${2/3*height}`)
                    .on('click', () => focusOn()); // Reset zoom on canvas click

                d3.json('data/flare.json', (error, root) => {
                    if (error) throw error;

                    root = d3.hierarchy(root);
                  	console.log(root)
                    root.sum(d => d.value);

                    const slice = svg.selectAll('g.slice')
                        .data(partition(root).descendants());

                    slice.exit().remove();

                    const newSlice = slice.enter()
                        .append('g').attr('class', 'slice')
                        .on('click', d => {
                            d3.event.stopPropagation();
                            console.log("- AGREGANDO: ")
                            console.log(d)
                            console.log("d.value: "+d.value)
                            if(d.value != d3.select("#queryDays").value){
                              console.log(d.value +" - "+ d3.select("#queryDays").node().value)

                              d3.select("#queryDays").node().value = d.value
                              //d3.select("#queryDays").node().value = d3.select("#queryDays").node().value?d3.select("#queryDays").node().value:0

                              paint(d)
                            }
                            focusOn(d);
                        });

                    newSlice.append('title')
                        .text(d => d.data.name + '\n' + formatNumber(d.value));

                    newSlice.append('path')
                        .attr('class', 'main-arc')
                        .style('fill', d => color((d.children ? d : d.parent).data.name))
                        .attr('d', arc);

                    newSlice.append('path')
                        .attr('class', 'hidden-arc')
                        .attr('id', (_, i) => `hiddenArc${i}`)
                        .attr('d', middleArcLine);

                    const text = newSlice.append('text')
                        .attr('display', d => textFits(d) ? null : 'none');

                    // Add white contour
                    text.append('textPath')
                        .attr('startOffset','50%')
                        .attr('xlink:href', (_, i) => `#hiddenArc${i}` )
                        .text(d => d.data.name)
                        .style('fill', 'none')
                        .style('stroke', '#fff')
                        .style('stroke-width', 5)
                        .style('stroke-linejoin', 'round');

                    text.append('textPath')
                        .attr('startOffset','50%')
                        .attr('xlink:href', (_, i) => `#hiddenArc${i}` )
                        .text(d => d.data.name);
                });

                        function paint(d){

                          const tds = d3.selectAll("td")
                            .each(function(x, y) {
                              d3.select(this).style("background-color", this.innerHTML == d.value ? "yellow" : null)
                            })
                        }
                function focusOn(d = { x0: 0, x1: 1, y0: 0, y1: 1 }) {
                    // Reset to top-level if no data point specified

                    const transition = svg.transition()
                        .duration(750)
                        .tween('scale', () => {
                            const xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                                yd = d3.interpolate(y.domain(), [d.y0, 1]);
                            return t => { x.domain(xd(t)); y.domain(yd(t)); };
                        });

                    transition.selectAll('path.main-arc')
                        .attrTween('d', d => () => arc(d));

                    transition.selectAll('path.hidden-arc')
                        .attrTween('d', d => () => middleArcLine(d));

                    transition.selectAll('text')
                        .attrTween('display', d => () => textFits(d) ? null : 'none');
                }

                    d3.select("#queryDays").on("change", function() {
                      //var v = d3.select(this)[0][0].value;
                      //var v = d3.select(this);
                      var v = this.value;
                      console.log(v)
                      moveStackToFront(v);
                                  function moveStackToFront(elD) {
                                      console.log("SI2: " + elD)
                                      svg.selectAll('.slice').filter(d => d.value == elD)
                                          .each(function(d) {
                                              console.log("SI")
                                              focusOn(d)
                                              paint(d)
                                          })
                                  }
                    })
            </script>
            <!-- Optional JavaScript -->
            <!-- jQuery first, then Popper.js, then Bootstrap JS -->
            <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
          </body>
        </html>
