<!DOCTYPE html PUBLIC “-//W3C//DTD XHTML 1.0 Transitional//EN” “http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd”>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <title>Versión 2 - Ricardo Rendich</title>
        <link type="text/css" rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css"/>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <link type="text/css" rel="stylesheet" href="css/style1.css"/>
    <link type="text/css" rel="stylesheet" href="css/style2.css"/>
    <link type="text/css" rel="stylesheet" href="css/style3.css"/>
  </head>
  <body>
          <div class="container-fluid">
              <h2>Relaciones entre ODS y PND</h2>
              <br />
              <br />
              <p>El gráfico de la izquierda muestra las relaciones de los Objetivos de Desarrollo Sustentable (ODS) con el Plan Nacional de Desarrollo (PND).</p>
              <p>Pasa el mouse sobre los distintos textos para destacar las relaciones, o haz click en ellos para mostrar la lista en la tabla de la derecha.</p>
              <p>El color amarillo (<span class='block_relation_Parcial'>&#9634;</span>) indica una vinculación parcial, mientras que el color color rojo (<span class='block_relation_Total'>&#9634;</span>) indica una vinculación total.</p>

              <div class="row">
                <div class="col-md-6">
                  <div id="bundle"></div>
                </div>
                <div class="col-md-6">
                  <div id="myTable3">
                  </div>
                </div>
              </div>
            </div>
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="libs/d3.v3.min.js"></script>
    <script type="text/javascript" src="libs/packages.js"></script>
    <script type="text/javascript">

      ///////////////////
      var tabulate3 = function (data,columns) {
          var table = d3.select('#myTable3')
          var thead = table.append('thead')
          var tbody = table.append('tbody')

            thead.append('tr')
              .selectAll('th')
                .data(columns)
                .enter()
              .append('th')
                .text(function (d) { return d })

            var rows = tbody.selectAll('tr')
                .data(data)
                .enter()
              .append('tr').attr('class', function (d) {
                // Objetivo:
                // "Numero" de Objetivo PND. Es "1.1.1" de "1.1.1 Garantizar a toda la población el derecho universal a la identidad."
                // Meta:
                // "Numero" de Meta Meta ODS. Es "16.9" de "16.9 De aquí a 2030, proporcionar acceso a una identidad jurídica para todos, en particular mediante el registro de nacimientos."
                return d.Objetivo +" "+d.Meta
               }) //AQUI
                 .each(function (d) {
                    //d3.select(this).style("visibility", "collapse");
                    d3.select(this).style("visibility", "visible");
                });


            var cells = rows.selectAll('td')
                .data(function(row, row_index) {
                    return columns.map(function (column, column_index) {
                      //console.log("row["+column+"("+row_index+"-"+column_index+")]: "+row[column])
                        return { column: column, value: row[column] }
                  })
              })
              .enter()
            .append('td')
              .text(function (d) { return d.value })

          return table;
        }
        //d3.csv("data/data.csv", function(error, data) {
        //d3.csv("data/data3.csv", function(error, data) {
        d3.csv("data/my_input3.csv", function(error, data) {
          //const columns = ["VALOR",'Eje','Objetivo Estratégico','Objetivo PND','Indicadores']
          //const columns = ['Eje','Objetivo Estratégico','Objetivo PND','Indicadores']
          //const columns = ["Objetivo","Meta ODS", "Objetivo Estratégico","Vinculación","Problemática ODS","Acción ODS","Sujeto ODS"]
          //const columns = ["Meta ODS", "Objetivo Estratégico","Vinculación","Problemática ODS","Acción ODS","Sujeto ODS"]
          const columns = ["Meta ODS","Objetivo PND", //"PND_grupo",
        "Vinculación",
        //"Problemática ODS",	"Acción ODS",	"Sujeto ODS"
        //Objetivo Estratégico	Objetivo PND	ODS	Meta ODS	PND_subgrupo	PND_grupo	ODS_grupo	ODS_subgrupo
      ]
          //Eje_n	Eje	Objetivo Estratégico	Objetivo PND	Sujeto PND 	Problemática PND	Acción PND	ODS	Meta	Meta ODS	Sujeto ODS	Problemática ODS	Acción ODS	Vinculación

          tabulate3(data,columns)
        });
    ////

    /*
    Basado en
      https://jsfiddle.net/Twisty/192m0uyc/2/
    */
      var count_aux = 10;

var w = 740,
    h = 700,
    rx = w / 2,
    ry = h / 2,
    m0,
    rotate = 0
    pi = Math.PI;

var splines = [];

var cluster = d3.layout.cluster()
    .size([360, ry - 180])
    // http://bl.ocks.org/mayblue9/dcc49ef6e3888f37f755177c4a248f2c ORDENAR
    .sort(function(a, b) { //console.log(a.key +" - "+ b.key);
    return d3.ascending(a.key, b.key);
  });

var bundle = d3.layout.bundle();

var line = d3.svg.line.radial()
    .interpolate("bundle")
    .tension(.85)
    .radius(function(d) { return d.y; })
    .angle(function(d) { return d.x / 180 * Math.PI; });

var div = d3.select("#bundle")
    .style("width", w + "px")
    .style("height", w + "px")
    .style("position", "absolute");

var svg = div.append("svg:svg")
    .attr("width", w)
    .attr("height", w)
  .append("svg:g")
    .attr("transform", "translate(" + rx + "," + ry + ")");

svg.append("svg:path")
    .attr("class", "arc")
    .attr("d", d3.svg.arc().outerRadius(ry - 180).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
    .on("mousedown", mousedown);

//d3.json("flare-imports.json", function(classes) {
//d3.json("data/mini.json", function(classes) {
d3.json("data/mini.json", function(classes) {

    var nodes = cluster.nodes(packages.root(classes)),
        //links = packages.imports(nodes), // NOMBRE de las conexiones imports(nodes),
        links = packages.imports(nodes),
        splines = bundle(links);

    var path = svg.selectAll("path.link")
        .data(links)
      .enter().append("svg:path")
        .attr("class", function(d) {
          //console.log("[79]")
            console.log(d)
          //return "link source-" + d.source.key + " target-" + d.target.key + " relation_"+d.relation;
        //return "link source-" + d.source.key + " target-" + d.target.key ;
        return "link source-" + d.source.key + " target-" + d.target.key + " relation_"+d.relation;
        })
        .attr("d", function(d, i) { return line(splines[i]); });

    var groupData = svg.selectAll("g.group")
      .data(nodes.filter(function(d) {
        return (d.key=='ODS_16_9' || d.key == 'ODS_3' || d.key == 'ODS_4' || d.key == 'ODS_16'
        || d.key == 'PND_1_1') && d.children;
      }))
    .enter().append("group")
      .attr("class", "group");

    var groupArc = d3.svg.arc()
    .innerRadius(ry - 177)
    .outerRadius(ry - 157)
  	//.padAngle(.02)
    .startAngle(function(d) { return (findStartAngle(d.__data__.children) - 2) * pi / 180;})
    .endAngle(function(d) { return (findEndAngle(d.__data__.children) + 2) * pi / 180});

    var colorScaleArc = d3.scale.quantize()
      //.domain([0,3])
      .domain([0,6])
      .range(["#FF0000", // Grupo 0 (fill: rgb(255, 0, 0); fill-opacity: 0.5;)
        "#00FF00", // ARISTA
        "#0000FF", // Grupo 1 (fill: rgb(0, 0, 255); fill-opacity: 0.5;)
        "#008888", //
        "#FF8888", // Grupo 2 (fill: rgb(255, 136, 136); fill-opacity: 0.5;)
        "#0088FF", // Grupo 3 (fill: rgb(255, 136, 255); fill-opacity: 0.5;)
        "#FF88FF" //
      ]);


    svg.selectAll("g.arc")
    .data(groupData[0])
  .enter().append("svg:path")
    .attr("d", groupArc)
    .attr("class", "groupArc")
    //.style("fill", "#1f77b4")
    //.style("fill-opacity", 0.5);
    .call(text => text.append("title").text( (d,i) =>
      {
        return  `ODS ${i}
      ${d.__data__.name} :
  Se compone de ${d.__data__.children.length} elementos`;
      }
    ))
    .style("fill", function(d, i) {
      console.log(i+": "+d.__data__.name);
      return colorScaleArc(i);
    }) // ARCOS ROJOS
    .style("fill-opacity", 0.5);

    svg.selectAll("g.node")
        .data(nodes.filter(function(n) { return !n.children; }))
      .enter().append("svg:g")
        .attr("class", "node")
        .attr("id", function(d) { return "node-" + d.key; })
        .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
      .append("svg:text")
        .attr("dx", function(d) { return d.x < 180 ? 25 : -25; })
        .attr("dy", ".31em")
        .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
        .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
        .text(function(d) { return d.key.replace(/_/g, ' '); })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("click", clickfunction)
        .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");});
});

d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);

function mouse(e) {
  return [e.pageX - rx, e.pageY - ry];
}
function clickfunction (e){
  console.log(e.key);
  console.log(e);

/************************************************************************************************************

AGREGAR ID AL EVENTO
 {name: "root.Jobs.Bayard", relation: "Total", imports: Array(3), parent: {…}, key: "Bayard", …}
FILTRAR CLASS == ID
*************************************************************************************************************/

}
function mousedown() {
  m0 = mouse(d3.event);
  d3.event.preventDefault();
}

function mousemove() {
  if (m0) {
    var m1 = mouse(d3.event),
        dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;
    div.style("-webkit-transform", "translate3d(0," + (ry - rx) + "px,0)rotate3d(0,0,0," + dm + "deg)translate3d(0," + (rx - ry) + "px,0)");
  }
}

function mouseup() {
    if (m0) {
        var m1 = mouse(d3.event),
            dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;

        rotate += dm;
        if (rotate > 360) rotate -= 360;
        else if (rotate < 0) rotate += 360;
        m0 = null;

        div.style("-webkit-transform", "rotate3d(0,0,0,0deg)");

        svg.attr("transform", "translate(" + rx + "," + ry + ")rotate(" + rotate + ")")
          .selectAll("g.node text")
            .attr("dx", function(d) { return (d.x + rotate) % 360 < 180 ? 25 : -25; })
            .attr("text-anchor", function(d) { return (d.x + rotate) % 360 < 180 ? "start" : "end"; })
            .attr("transform", function(d) { return (d.x + rotate) % 360 < 180 ? null : "rotate(180)"; });
    }
}

var tooltip = d3.select("body")
	.append("div")
  .attr("class", "tooltip")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden");//.text("Tooltip");
  //.html('<h1>ALGO</h1>'+'Otro<br />asd');

function mouseover(d) {
  console.log(d)
  //link source-ODS_16.9 target-PND_1.1.1 relation_Parcial
    svg.selectAll("path.link.target-" + d.key)
        .classed("target", true)
        .each(updateNodes("source", true));

    svg.selectAll("path.link.source-" + d.key)
        .classed("source", true)
        .each(updateNodes("target", true));

      var msg = "<ul>";
      var node = (svg.selectAll("path.link.source-" + d.key)).filter(function(d2){
          msa = d3.select(this).attr('class');
          msa.split(" ").forEach(function(a) {
            class_name = "target-";
            if(a != "link" && (a.includes(class_name)))
            {msg += "<li>"+a.substring(class_name.length) +"</li>";}
          }); // forEach
        }); // filter

      var node = (svg.selectAll("path.link.target-" + d.key)).filter(function(d2){
          msa = d3.select(this).attr('class');
          msa.split(" ").forEach(function(a) {
            class_name = "source-";
            if(a != "link" && (a.includes(class_name)))
              {msg += "<li>"+a.substring(class_name.length) +"</li>";}
          });// forEach
        });//filter

        N = (svg.selectAll("path.link.target-" + d.key)).size() + (svg.selectAll("path.link.source-" + d.key)).size();
        if(N==1){
          tooltip.html( d.key+' tiene <b>'+1+'</b> conexión'+ msg+"</li>");
        }else{
          tooltip.html( d.key+' tiene <b>'+N+'</b> conexiones'+ msg+"</li>" );
        }
        return tooltip.style("visibility", "visible");
}

function mouseout(d) {
    svg.selectAll("path.link.source-" + d.key)
        .classed("source", false)
        .each(updateNodes("target", false));

    svg.selectAll("path.link.target-" + d.key)
        .classed("target", false)
        .each(updateNodes("source", false));
    return tooltip.style("visibility", "hidden");
}

function updateNodes(name, value) {
  return function(d) {
    if (value) this.parentNode.appendChild(this);
    svg.select("#node-" + d[name].key).classed(name, value);
  };
}

function cross(a, b) {
  return a[0] * b[1] - a[1] * b[0];
}

function dot(a, b) {
  return a[0] * b[0] + a[1] * b[1];
}

function findStartAngle(children) {
    var min = children[0].x;
    children.forEach(function(d) {
       if (d.x < min)
           min = d.x;
    });
    return min;
}

function findEndAngle(children) {
    var max = children[0].x;
    children.forEach(function(d) {
       if (d.x > max)
           max = d.x;
    });
    return max;
}
///////////////////


    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </body>
</html>
